<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dependency API Test Helper</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-6 text-blue-600">🔗 Dependency API Test Helper</h1>
    
    <!-- Step 1: Get Response IDs -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">📋 Step 1: Find Response IDs</h2>
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">Enter Checklist ID:</label>
        <input 
          type="number" 
          id="checklistId" 
          value="28"
          class="border border-gray-300 rounded px-3 py-2 w-full"
          placeholder="e.g., 28"
        >
      </div>
      <button 
        onclick="loadChecklistItems()"
        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
      >
        Load Checklist Items
      </button>
      
      <div id="itemsTable" class="mt-4"></div>
    </div>
    
    <!-- Step 2: Test APIs -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-semibold mb-4">🧪 Step 2: Test Dependency APIs</h2>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium mb-2">Response ID 1 (depends on this):</label>
          <input 
            type="number" 
            id="responseId1" 
            class="border border-gray-300 rounded px-3 py-2 w-full"
            placeholder="e.g., 98"
          >
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">Response ID 2 (will depend):</label>
          <input 
            type="number" 
            id="responseId2" 
            class="border border-gray-300 rounded px-3 py-2 w-full"
            placeholder="e.g., 99"
          >
        </div>
      </div>
      
      <button 
        onclick="runAllTests()"
        class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 font-semibold"
      >
        🚀 Run All Tests
      </button>
      
      <div id="testResults" class="mt-4"></div>
    </div>
  </div>

  <script>
    async function loadChecklistItems() {
      const checklistId = document.getElementById('checklistId').value;
      const resultsDiv = document.getElementById('itemsTable');
      
      try {
        resultsDiv.innerHTML = '<p class="text-gray-600">Loading...</p>';
        
        const response = await fetch(`/api/checklists/${checklistId}`, {
          credentials: 'include'
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const checklist = await response.json();
        
        let html = `
          <div class="border border-gray-200 rounded mt-4">
            <div class="bg-gray-50 px-4 py-2 border-b border-gray-200">
              <h3 class="font-semibold">${checklist.title}</h3>
              <p class="text-sm text-gray-600">Checklist ID: ${checklist.id}</p>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="px-4 py-2 text-left">Response ID ← USE THIS</th>
                    <th class="px-4 py-2 text-left">Template ID</th>
                    <th class="px-4 py-2 text-left">Item Text</th>
                    <th class="px-4 py-2 text-center">Completed</th>
                  </tr>
                </thead>
                <tbody>
        `;
        
        checklist.sections.forEach(section => {
          section.items.forEach(item => {
            html += `
              <tr class="border-t border-gray-200 hover:bg-gray-50">
                <td class="px-4 py-2 font-mono font-bold text-blue-600">${item.response_id}</td>
                <td class="px-4 py-2 font-mono text-gray-500">${item.template_item_id}</td>
                <td class="px-4 py-2">${item.item_text}</td>
                <td class="px-4 py-2 text-center">
                  ${item.is_completed ? '✅' : '❌'}
                </td>
              </tr>
            `;
          });
        });
        
        html += `
                </tbody>
              </table>
            </div>
            <div class="bg-yellow-50 border-t border-yellow-200 px-4 py-3">
              <p class="text-sm font-semibold text-yellow-800">
                ⚠️ Important: Use the <strong>Response ID</strong> (blue column) for dependency APIs, NOT the Template ID!
              </p>
            </div>
          </div>
        `;
        
        resultsDiv.innerHTML = html;
        
      } catch (error) {
        resultsDiv.innerHTML = `
          <div class="bg-red-50 border border-red-200 rounded p-4 mt-4">
            <p class="text-red-800">❌ Error: ${error.message}</p>
          </div>
        `;
      }
    }
    
    async function runAllTests() {
      const responseId1 = parseInt(document.getElementById('responseId1').value);
      const responseId2 = parseInt(document.getElementById('responseId2').value);
      const resultsDiv = document.getElementById('testResults');
      
      if (!responseId1 || !responseId2) {
        alert('Please enter both response IDs');
        return;
      }
      
      let output = '<div class="bg-gray-50 rounded p-4 mt-4 font-mono text-sm space-y-4">';
      
      try {
        // Test 1: Add dependency
        output += '<div class="border-b border-gray-300 pb-3"><strong>━━━ Test 1: Add Dependency ━━━</strong><br>';
        const addResult = await fetch(`/api/checklist-items/${responseId2}/dependencies`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ dependsOnItemId: responseId1 })
        }).then(r => r.json());
        output += `Result: ${JSON.stringify(addResult, null, 2)}<br>`;
        output += addResult.success ? '<span class="text-green-600 font-bold">✅ PASS</span></div>' : '<span class="text-red-600 font-bold">❌ FAIL</span></div>';
        
        if (!addResult.success) {
          output += '</div>';
          resultsDiv.innerHTML = output;
          return;
        }
        
        // Test 2: Get dependencies
        output += '<div class="border-b border-gray-300 pb-3"><strong>━━━ Test 2: Get Dependencies ━━━</strong><br>';
        const deps = await fetch(`/api/checklist-items/${responseId2}/dependencies`, {
          credentials: 'include'
        }).then(r => r.json());
        output += `Count: ${deps.count}<br>`;
        output += `Dependencies: ${JSON.stringify(deps.dependencies, null, 2)}<br>`;
        output += deps.count > 0 ? '<span class="text-green-600 font-bold">✅ PASS</span></div>' : '<span class="text-red-600 font-bold">❌ FAIL</span></div>';
        
        // Test 3: Check blocking status
        output += '<div class="border-b border-gray-300 pb-3"><strong>━━━ Test 3: Blocking Status ━━━</strong><br>';
        const blocking = await fetch(`/api/checklist-items/${responseId2}/blocking-status`, {
          credentials: 'include'
        }).then(r => r.json());
        output += `Is Blocked: ${blocking.isBlocked}<br>`;
        output += `Blocked By: ${JSON.stringify(blocking.blockedBy, null, 2)}<br>`;
        output += `Total Deps: ${blocking.totalDependencies}<br>`;
        output += `Completed: ${blocking.completedDependencies}<br>`;
        output += blocking.isBlocked === true ? '<span class="text-green-600 font-bold">✅ PASS</span></div>' : '<span class="text-red-600 font-bold">❌ FAIL</span></div>';
        
        // Test 4: Get dependent items
        output += '<div class="border-b border-gray-300 pb-3"><strong>━━━ Test 4: Dependent Items ━━━</strong><br>';
        const dependents = await fetch(`/api/checklist-items/${responseId1}/dependent-items`, {
          credentials: 'include'
        }).then(r => r.json());
        output += `Count: ${dependents.count}<br>`;
        output += `Dependent Items: ${JSON.stringify(dependents.dependentItems, null, 2)}<br>`;
        output += dependents.count > 0 ? '<span class="text-green-600 font-bold">✅ PASS</span></div>' : '<span class="text-red-600 font-bold">❌ FAIL</span></div>';
        
        // Test 5: Circular dependency
        output += '<div class="border-b border-gray-300 pb-3"><strong>━━━ Test 5: Circular Dependency (Should Fail) ━━━</strong><br>';
        const circular = await fetch(`/api/checklist-items/${responseId1}/dependencies`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ dependsOnItemId: responseId2 })
        }).then(r => r.json());
        output += `Result: ${JSON.stringify(circular, null, 2)}<br>`;
        const circularBlocked = circular.error && (circular.error.includes('circular') || circular.error.includes('Circular'));
        output += circularBlocked ? '<span class="text-green-600 font-bold">✅ PASS (correctly prevented)</span></div>' : '<span class="text-red-600 font-bold">❌ FAIL</span></div>';
        
        // Test 6: Remove dependency
        output += '<div><strong>━━━ Test 6: Remove Dependency ━━━</strong><br>';
        const depId = deps.dependencies[0]?.dependency_id;
        if (depId) {
          const removeResult = await fetch(`/api/dependencies/${depId}`, {
            method: 'DELETE',
            credentials: 'include'
          }).then(r => r.json());
          output += `Result: ${JSON.stringify(removeResult, null, 2)}<br>`;
          output += removeResult.success ? '<span class="text-green-600 font-bold">✅ PASS</span></div>' : '<span class="text-red-600 font-bold">❌ FAIL</span></div>';
        } else {
          output += '⚠️ No dependency ID found to remove</div>';
        }
        
        output += '<div class="mt-4 p-3 bg-green-100 border border-green-300 rounded text-green-800 font-bold">🎉 All API tests complete!</div>';
        
      } catch (error) {
        output += `<div class="bg-red-100 border border-red-300 rounded p-3 text-red-800">❌ Test suite failed: ${error.message}</div>`;
      }
      
      output += '</div>';
      resultsDiv.innerHTML = output;
    }
  </script>
</body>
</html>
