 Create a simple integration test: tests/test-dependency-integration.js

  This is a LIGHTWEIGHT integration test that verifies database operations work correctly.
  The unit tests already cover the logic - this just tests database connectivity.

  Test only 2 scenarios:
  1. Create dependencies in database
  2. Retrieve dependency graph from database

  const dependencyMapper = require('../services/dependency-mapper');
  const { pool } = require('../db');

  async function runIntegrationTest() {
    console.log('ðŸ”— DEPENDENCY MAPPER - INTEGRATION TEST\n');
    console.log('Unit tests already verify logic âœ…');
    console.log('This test verifies database operations\n');

    let projectId;

    try {
      // Setup: Create test project and issues
      console.log('Setup: Creating test data...');

      const projectResult = await pool.query(
        `INSERT INTO projects (name, description, owner_id)
         VALUES ($1, $2, $3) RETURNING id`,
        ['Integration Test Project', 'Testing DB operations', 1]
      );
      projectId = projectResult.rows[0].id;

      // Create 3 test issues
      const issue1 = await pool.query(
        `INSERT INTO issues (project_id, title, status, created_by)
         VALUES ($1, $2, $3, $4) RETURNING id`,
        [projectId, 'Phase 1: Discovery', 'open', 1]
      );

      const issue2 = await pool.query(
        `INSERT INTO issues (project_id, title, status, created_by)
         VALUES ($1, $2, $3, $4) RETURNING id`,
        [projectId, 'Phase 2: Design', 'open', 1]
      );

      const issue3 = await pool.query(
        `INSERT INTO issues (project_id, title, status, created_by)
         VALUES ($1, $2, $3, $4) RETURNING id`,
        [projectId, 'Phase 3: Implementation', 'open', 1]
      );

      console.log(`âœ“ Created project ${projectId} with 3 issues\n`);

      // TEST 1: Create Dependencies
      console.log('Test 1: Create dependencies in database');
      console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');

      const workstreams = [
        { name: 'Phase 1: Discovery', dependencies: [] },
        { name: 'Phase 2: Design', dependencies: ['Phase 1: Discovery'] },
        { name: 'Phase 3: Implementation', dependencies: ['Phase 2: Design'] }
      ];

      const result = await dependencyMapper.createDependencies(workstreams, projectId);

      console.log(`  Dependencies created: ${result.dependencies.length}`);
      console.log(`  Warnings: ${result.warnings.length}`);
      console.log(`  Errors: ${result.errors.length}`);

      result.dependencies.forEach(dep => {
        console.log(`  âœ“ ${dep.source_name} â†’ ${dep.target_name}`);
      });

      if (result.dependencies.length === 2 && result.errors.length === 0) {
        console.log('âœ… Test 1 PASSED\n');
      } else {
        console.log('âŒ Test 1 FAILED\n');
        throw new Error('Dependency creation failed');
      }

      // TEST 2: Retrieve Dependency Graph
      console.log('Test 2: Retrieve dependency graph from database');
      console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');

      const graph = await dependencyMapper.getDependencyGraph(projectId);

      console.log(`  Dependencies retrieved: ${graph.length}`);
      graph.forEach(dep => {
        console.log(`  âœ“ ${dep.source_title} â†’ ${dep.target_title} (${dep.relationship_type})`);
      });

      if (graph.length === 2) {
        console.log('âœ… Test 2 PASSED\n');
      } else {
        console.log('âŒ Test 2 FAILED\n');
        throw new Error('Dependency retrieval failed');
      }

      // Verify polymorphic structure
      console.log('Test 3: Verify polymorphic table structure');
      console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');

      const dbCheck = await pool.query(
        `SELECT source_type, target_type, relationship_type
         FROM issue_relationships
         WHERE source_id = $1 AND target_id = $2
         LIMIT 1`,
        [issue1.rows[0].id, issue2.rows[0].id]
      );

      if (dbCheck.rows.length > 0) {
        const row = dbCheck.rows[0];
        console.log(`  âœ“ source_type: ${row.source_type}`);
        console.log(`  âœ“ target_type: ${row.target_type}`);
        console.log(`  âœ“ relationship_type: ${row.relationship_type}`);

        if (row.source_type === 'issue' && row.target_type === 'issue' && row.relationship_type === 'dependency') {
          console.log('âœ… Test 3 PASSED\n');
        } else {
          console.log('âŒ Test 3 FAILED - Incorrect types\n');
        }
      } else {
        console.log('âŒ Test 3 FAILED - Record not found\n');
      }

      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('âœ… ALL INTEGRATION TESTS PASSED!');
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

    } catch (error) {
      console.error('\nâŒ Integration test failed:', error);
      throw error;
    } finally {
      // Cleanup
      if (projectId) {
        console.log('Cleanup: Removing test data...');
        await pool.query(
          `DELETE FROM issue_relationships
           WHERE source_id IN (SELECT id FROM issues WHERE project_id = $1)`,
          [projectId]
        );
        await pool.query('DELETE FROM issues WHERE project_id = $1', [projectId]);
        await pool.query('DELETE FROM projects WHERE id = $1', [projectId]);
        console.log('âœ“ Cleanup complete\n');
      }
    }
  }

  runIntegrationTest()
    .then(() => {
      console.log('ðŸŽ‰ Integration test suite completed successfully!');
      process.exit(0);
    })
    .catch(error => {
      console.error('ðŸ’¥ Integration test suite failed!');
      console.error(error);
      process.exit(1);
    });

  Run with:
  node tests/test-dependency-integration.js